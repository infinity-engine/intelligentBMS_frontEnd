<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>intelligent-bms documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">intelligent-bms documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  Charts</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/components/body/battery-test/show-test-result/show-test-result.component.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#chartData" 
>
                                            chartData
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#ChartOptions" 
>
                                            ChartOptions
                                        </a>
                                </li>
                                <li>
                                        <a href="#ChartType" 
>
                                            ChartType
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#name" 
>
                                            name
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="chartData"></a>
                                        <span class="name "><b>chartData</b>
                                            <a href="#chartData">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>chartData:     <code> | any</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code> | any</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="ChartOptions"></a>
                                        <span class="name "><b>ChartOptions</b>
                                            <a href="#ChartOptions">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>ChartOptions:     <code> | any</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code> | any</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="ChartType"></a>
                                        <span class="name "><b>ChartType</b>
                                            <a href="#ChartType">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>ChartType:     <code>ChartType</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>ChartType</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="name"></a>
                                        <span class="name "><b>name</b>
                                            <a href="#name">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>name:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { ComponentStoreService } from &#x27;./../../../../services/component-store.service&#x27;;
import {
  _TestResultDeep,
  QuickResponseMeasurement,
  MeasuredParameters,
  SensorObj,
} from &#x27;./../../../../models/TestResult&#x27;;
import { TestChamberService } from &#x27;src/app/services/test-chamber.service&#x27;;
import { of, Subscription, switchMap } from &#x27;rxjs&#x27;;
import { ActivatedRoute } from &#x27;@angular/router&#x27;;
import { NgbModal } from &#x27;@ng-bootstrap/ng-bootstrap&#x27;;
import { saveAs } from &#x27;file-saver&#x27;;

import { ChartConfiguration, ChartType } from &#x27;chart.js&#x27;;
import {
  Component,
  OnInit,
  OnDestroy,
  QueryList,
  ViewChildren,
  ViewChild,
} from &#x27;@angular/core&#x27;;
import { BaseChartDirective } from &#x27;ng2-charts&#x27;;
import { Location } from &#x27;@angular/common&#x27;;

interface Charts {
  name?: string;
  chartData?: ChartConfiguration[&#x27;data&#x27;] | any;
  ChartOptions?: ChartConfiguration[&#x27;options&#x27;] | any;
  ChartType: ChartType;
}

@Component({
  selector: &#x27;app-show-test-result&#x27;,
  templateUrl: &#x27;./show-test-result.component.html&#x27;,
  styleUrls: [&#x27;./show-test-result.component.css&#x27;],
})
export class ShowTestResultComponent implements OnInit, OnDestroy {
  subs: Subscription[] &#x3D; [];
  testInfo?: _TestResultDeep;
  showChart: boolean &#x3D; false;
  allCharts: Charts[] &#x3D; [];
  quickResponses: QuickResponseMeasurement[] &#x3D; [];
  chartSub?: Subscription;
  testId?: string | null;
  chamberId?: string | null;
  measurementUpdateIntervalId: any;
  testInfoIntervalId: any;
  testInfoSub?: Subscription;
  modalTitle?: string;
  modalBody?: string;

  @ViewChildren(BaseChartDirective) charts?: QueryList&lt;BaseChartDirective&gt;;
  @ViewChild(&#x27;myModal&#x27;) modal: any;

  constructor(
    private route: ActivatedRoute,
    private _testChamberService: TestChamberService,
    private _componentStoreService: ComponentStoreService,
    private modalService: NgbModal,
    private location: Location
  ) {}

  toggleShowChart() {
    this.showChart &#x3D; !this.showChart;
    clearInterval(this.measurementUpdateIntervalId);
    this.chartSub?.unsubscribe();
  }

  onClickChild(event: MouseEvent) {
    event.stopPropagation();
  }

  onClickParent(event: MouseEvent) {
    this.toggleShowChart();
  }
  showChartView(channelNo: number) {
    this.allCharts &#x3D; [];
    this.toggleShowChart();
    const channelQuickResponse &#x3D; this.quickResponses.find(
      (res) &#x3D;&gt; res.channelNo &#x3D;&#x3D;&#x3D; channelNo
    );
    if (channelQuickResponse) {
      this.createChart(channelQuickResponse);
      this.keepUpdatingChart(channelQuickResponse);
    } else {
      const sub &#x3D; this._testChamberService
        .getQuickResponse(
          this.chamberId as any,
          this.testId as any,
          channelNo as any
        )
        .subscribe((data: QuickResponseMeasurement) &#x3D;&gt; {
          this.createChart(data);
          this.quickResponses.push(data);
          if (data.statusCh &#x3D;&#x3D;&#x3D; &#x27;Running&#x27;) {
            //if channel is running then only keep updating the channel
            this.keepUpdatingChart(data);
          }
          sub.unsubscribe();
        });
    }
  }
  createChart(channelQuickResponse: QuickResponseMeasurement) {
    if (
      channelQuickResponse.measuredParameters.current &amp;&amp;
      channelQuickResponse.measuredParameters.current.length &gt; 0
    ) {
      let chart: Charts &#x3D; {
        name: &#x27;Current&#x27;,
        chartData: {
          datasets: [
            {
              data: channelQuickResponse.measuredParameters.current,
              label: &#x27;Current&#x27;,
            },
          ],
          labels: channelQuickResponse.measuredParameters.time,
        },
        ChartOptions: {
          scales: {
            xAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Time(S)&#x27;,
                },
              },
            ],
            yAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Cell Current (A)&#x27;,
                },
              },
            ],
          },
        },
        ChartType: &#x27;line&#x27;,
      };
      this.allCharts.push(chart);
    }
    if (
      channelQuickResponse.measuredParameters.voltage &amp;&amp;
      channelQuickResponse.measuredParameters.voltage.length &gt; 0
    ) {
      let chart: Charts &#x3D; {
        name: &#x27;Voltage&#x27;,
        chartData: {
          datasets: [
            {
              data: channelQuickResponse.measuredParameters.voltage,
              label: &#x27;Voltage&#x27;,
            },
          ],
          labels: channelQuickResponse.measuredParameters.time,
        },
        ChartOptions: {
          scales: {
            xAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Time(S)&#x27;,
                },
              },
            ],
            yAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Cell Voltage(V)&#x27;,
                },
              },
            ],
          },
        },
        ChartType: &#x27;line&#x27;,
      };
      this.allCharts.push(chart);
    }
    if (
      channelQuickResponse.measuredParameters.chamberTemp &amp;&amp;
      channelQuickResponse.measuredParameters.chamberTemp.length &gt; 0
    ) {
      let chart: Charts &#x3D; {
        name: &#x27;Chamber Temperature&#x27;,
        chartData: {
          datasets: [
            {
              data: channelQuickResponse.measuredParameters.chamberTemp,
              label: &#x27;Chamber Temperature&#x27;,
            },
          ],
          labels: channelQuickResponse.measuredParameters.time,
        },
        ChartOptions: {
          scales: {
            xAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Time(S)&#x27;,
                },
              },
            ],
            yAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Chamber Temperature (°C)&#x27;,
                },
              },
            ],
          },
        },
        ChartType: &#x27;line&#x27;,
      };
      this.allCharts.push(chart);
    }
    if (
      channelQuickResponse.measuredParameters.chamberHum &amp;&amp;
      channelQuickResponse.measuredParameters.chamberHum.length &gt; 0
    ) {
      let chart: Charts &#x3D; {
        name: &#x27;Chamber Humidity&#x27;,
        chartData: {
          datasets: [
            {
              data: channelQuickResponse.measuredParameters.chamberHum,
              label: &#x27;Chamber Humidity&#x27;,
            },
          ],
          labels: channelQuickResponse.measuredParameters.time,
        },
        ChartOptions: {
          scales: {
            xAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Time(S)&#x27;,
                },
              },
            ],
            yAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Chamber Humidity(%)&#x27;,
                },
              },
            ],
          },
        },
        ChartType: &#x27;line&#x27;,
      };
      this.allCharts.push(chart);
    }

    if (
      channelQuickResponse.measuredParameters.cellTemp &amp;&amp;
      channelQuickResponse.measuredParameters.cellTemp.length &gt; 0
    ) {
      let chart: Charts &#x3D; {
        name: &#x27;Cell Temperature&#x27;,
        chartData: {
          datasets: [],
          labels: channelQuickResponse.measuredParameters.time,
        },
        ChartOptions: {
          scales: {
            xAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Time(S)&#x27;,
                },
              },
            ],
            yAxes: [
              {
                scaleLabel: {
                  display: true,
                  labelString: &#x27;Cell Temperatures(°C)&#x27;,
                },
              },
            ],
          },
        },
        ChartType: &#x27;line&#x27;,
      };
      channelQuickResponse.measuredParameters.cellTemp.forEach(
        (tempObj: SensorObj) &#x3D;&gt; {
          chart.chartData.datasets.push({
            data: tempObj.values,
            label: &#x27;Sensor&#x27; + tempObj.sensorId,
          });
        }
      );
      this.allCharts.push(chart);
    }
  }
  keepUpdatingChart(channelQuickResponse: QuickResponseMeasurement) {
    clearInterval(this.measurementUpdateIntervalId);
    this.measurementUpdateIntervalId &#x3D; setInterval(() &#x3D;&gt; {
      this.chartSub &#x3D; this._testChamberService
        .getQuickResponse(
          this.chamberId as any,
          this.testId as any,
          channelQuickResponse.channelNo as any,
          channelQuickResponse.measuredParameters.time
            ? channelQuickResponse.measuredParameters.time?.length - 1
            : 0
        )
        .subscribe((data: any) &#x3D;&gt; {
          this.appendNewData(
            channelQuickResponse.measuredParameters,
            data.measuredParameters as MeasuredParameters
          );
          this.charts?.forEach((chart) &#x3D;&gt; chart.update());
          this.chartSub?.unsubscribe();
        });
    }, 2000);
  }
  appendNewData(
    prevMeasurements: MeasuredParameters,
    newMeasurements: MeasuredParameters
  ) {
    if (newMeasurements.current &amp;&amp; newMeasurements.current?.length &gt; 0) {
      prevMeasurements.current?.push(...newMeasurements.current);
    }
    if (newMeasurements.voltage &amp;&amp; newMeasurements.voltage?.length &gt; 0) {
      prevMeasurements.voltage?.push(...newMeasurements.voltage);
    }
    if (newMeasurements.chamberHum &amp;&amp; newMeasurements.chamberHum?.length &gt; 0) {
      prevMeasurements.chamberHum?.push(...newMeasurements.chamberHum);
    }
    if (
      newMeasurements.chamberTemp &amp;&amp;
      newMeasurements.chamberTemp?.length &gt; 0
    ) {
      prevMeasurements.chamberTemp?.push(...newMeasurements.chamberTemp);
    }
    if (newMeasurements.time &amp;&amp; newMeasurements.time?.length &gt; 0) {
      prevMeasurements.time?.push(...newMeasurements.time);
    }
    newMeasurements.cellTemp?.forEach((tempObjNew, i) &#x3D;&gt; {
      const tempObjOld &#x3D; prevMeasurements.cellTemp?.find(
        (tempObj) &#x3D;&gt; tempObj.sensorId &#x3D;&#x3D;&#x3D; tempObjNew.sensorId
      );
      if (tempObjOld) {
        tempObjOld.values.push(...tempObjNew.values);
      } else {
        prevMeasurements.cellTemp?.push(tempObjNew);
      }
    });
  }

  ngOnInit(): void {
    if (window.location.hostname !&#x3D; &#x27;localhost&#x27;) {
      this.location.replaceState(&#x27;./&#x27;); //on prod
    }
    const os$ &#x3D; this.route.paramMap.pipe(
      switchMap((params) &#x3D;&gt; {
        this.testId &#x3D; params.get(&#x27;testId&#x27;);
        this.chamberId &#x3D; params.get(&#x27;chamberId&#x27;);
        return this._testChamberService.getTestData(
          this.chamberId as any,
          this.testId as any
        );
      })
    );
    this.testInfoSub &#x3D; os$.subscribe((testInfo: _TestResultDeep) &#x3D;&gt; {
      this.testInfo &#x3D; testInfo;
      this.testInfoSub?.unsubscribe();
    });
    this.testInfoIntervalId &#x3D; setInterval(() &#x3D;&gt; {
      if (this.testId &amp;&amp; this.chamberId) {
        this.testInfoSub?.unsubscribe();
        this.testInfoSub &#x3D; this._testChamberService
          .getTestData(this.chamberId as any, this.testId as any)
          .subscribe((testInfo) &#x3D;&gt; {
            this.testInfo &#x3D; testInfo;
            this.testInfoSub?.unsubscribe();
          });
      }
    }, 10000);
  }
  edit() {}
  play() {
    this.changeStatus(&#x27;Running&#x27;);
  }
  pause() {
    this.changeStatus(&#x27;Paused&#x27;);
  }
  stop() {
    this.modalTitle &#x3D; &#x27;Alert&#x27;;
    this.modalBody &#x3D;
      &#x27;Are you sure you want to stop the experiment? Once you stop it, you can never start it again.&#x27;;
    this.modalService.open(this.modal, { centered: true }).result.then(
      (result) &#x3D;&gt; {
        //console.log(&#x27;accepted&#x27;);
        this.changeStatus(&#x27;Stopped&#x27;);
      },
      (reason) &#x3D;&gt; {
        //console.log(&#x27;closed&#x27;);
      }
    );
  }
  changeStatus(status: string | null) {
    const sub &#x3D; this._testChamberService
      .forceStatus(this.chamberId as any, this.testId as any, status)
      .subscribe((res: any) &#x3D;&gt; {
        if (res.acknowledged) {
          this._componentStoreService.sendToastMsg({
            msg: &#x27;Status has been sent to the cloud. Wait for the Test Chamber to reflect the status&#x27;,
            timeOut: 10000,
            color: &#x27;black&#x27;,
          });
        }
      });
    this.subs.push(sub);
  }

  download(channelNo: number) {
    this._testChamberService
      .downloadTestResult(this.chamberId as any, this.testId as any, channelNo)
      .subscribe((response) &#x3D;&gt; {
        const blob &#x3D; new Blob([response.body], {
          type: &#x27;text/csv;charset&#x3D;utf-8;&#x27;,
        });
        const url &#x3D; URL.createObjectURL(blob);
        const contentDispositionHeader &#x3D; response.headers.get(
          &#x27;content-disposition&#x27;
        );
        const filename &#x3D; contentDispositionHeader
          ? contentDispositionHeader.split(&#x27;filename&#x3D;&#x27;)[1].replace(/&quot;/g, &#x27;&#x27;)
          : &#x27;testResult.csv&#x27;;
        saveAs(url, filename);
      });
  }
  ngOnDestroy(): void {
    this.subs.forEach((sub) &#x3D;&gt; sub.unsubscribe());
    this.testInfoSub?.unsubscribe();
    this.chartSub?.unsubscribe();
    clearInterval(this.measurementUpdateIntervalId);
    clearInterval(this.testInfoIntervalId);
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'Charts.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
